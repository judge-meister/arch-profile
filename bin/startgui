#!/bin/bash
#
# startgui
#

error_exit() 
{ 
  echo $1 
  exit 1 
}

get_dm_list()
{
  find /usr/share/xsessions/ -type f -exec grep  '^Exec=' {} \; | sed 's/Exec=//g'
  find /usr/share/wayland-sessions/ -type f -exec grep  '^Exec=' {} \; | sed 's/Exec=//g'
}

# already running a dm ?
[ -n "$DISPLAY" ] && [ "x$STARTGUI_TEST" == "x" ] && error_exit "A window manager appears to already be running."

# possible window managers 
# (console plasma i3 i3-gaps enlightenment awesome dwm sway)
declare -a DM_LIST=(console $(get_dm_list))

load_last_dm()
{
  # load last_dm
  LAST_NUM=0
  LAST_DM=console
  [ -f ~/.last_dm ] && LAST_DM=$(cat ~/.last_dm)
  for x in $(seq 0 $((${#DM_LIST[@]}-1)))
  do
    if [ "$LAST_DM" == "${DM_LIST[$x]}" ]
    then
      LAST_NUM=$x
    fi
  done
}

# pick which interface to start
pick_wm()
{
  echo "Pick a desktop"
  echo ""
  for x in $(seq 0 $((${#DM_LIST[@]}-1)))
  do
    if [ "$LAST_NUM" -eq "$x" ]
    then
      echo "${x}) ${DM_LIST[$x]}       <<-- Last Display Manager"
    else
      echo "${x}) ${DM_LIST[$x]}"
    fi
  done
  # add other options
  echo
  echo "l) Log Out"
  echo "p) Power Off"
  echo "r) Reboot"
  echo
  echo "Default is the ${DM_LIST[${LAST_NUM}]} [${LAST_NUM}]"
  read -r dm

  if [ "$dm" == "" ]
  then 
    dm=$LAST_NUM
  fi

}

while :
do
  load_last_dm
  pick_wm
  echo

  case $dm in
    p) echo "Powerin Off"; sleep 1; poweroff ;;
    r) echo "Rebooting";   sleep 1; reboot ;;
    l) echo "Logging Out"; sleep 1; exit ;;
  esac

  echo "${DM_LIST[$dm]}" > ~/.last_dm

  #echo "startx ~/.xinitrc ${DM_LIST[$dm]}"; 
  echo "start ${DM_LIST[$dm]}"
  sleep 1

  case "${DM_LIST[$dm]}" in
    sway) xbindkeys; sway ;;

    console) bash;;
    
    *) startx ~/.xinitrc "${DM_LIST[$dm]}";;
  esac

  #if [ "${DM_LIST[$dm]}" == "sway" ]
  #then
  #  echo sway; sleep 1
  #  xbindkeys
  #  sway
  #elif [ "${DM_LIST[$dm]}" == "console" ]
  #then
  #  echo "start console"; sleep 1
  #  bash
  #else
  #  echo "startx ~/.xinitrc ${DM_LIST[$dm]}"; sleep 1
  #  startx ~/.xinitrc "${DM_LIST[$dm]}"
  #fi
done


